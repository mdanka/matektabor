{% load staticfiles %}

<link rel="stylesheet/less" type="text/css" href="{% static 'barkochba/style.less' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'lib/select2-3.5.1/select2.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'lib/bootstrap-3.2.0/css/bootstrap.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'lib/bootstrap-3.2.0/css/bootstrap-theme.css' %}" />

<script src="{% static 'lib/jquery-2.1.1.js' %}" type="text/javascript"></script>
<script src="{% static 'lib/jquery.cookie-1.4.1.js' %}" type="text/javascript"></script>
<script src="{% static 'lib/select2-3.5.1/select2.js' %}"></script>
<script src="{% static 'lib/select2-3.5.1/select2_locale_hu.js' %}"></script>
<script src="{% static 'lib/less-1.7.5.js' %}" type="text/javascript"></script>
<script src="{% static 'lib/underscore-1.7.0.js' %}" type="text/javascript"></script>
<script src="{% static 'lib/bootstrap-3.2.0/js/bootstrap.js' %}" type="text/javascript"></script>

<script type="text/javascript">
function _namesChanged() {
	selectedPersonIdsString = $("#names-input").val();
	selectedPersonIds = _.map(selectedPersonIdsString.split(','), function (value) {
		return Number(value);
	});
	$('a.barkochba-story-summary').each(function() {
		storyPersonIds = $(this).data("person-ids");
		heardStoryPersonIds = _.intersection(selectedPersonIds, storyPersonIds);
		hasHeardStory = heardStoryPersonIds.length > 0;
		if (hasHeardStory) {
			$(this).slideUp();
		} else {
			$(this).slideDown();
		}
	});
}

function _storySelected(storyId) {
	// Select the summary
	$('a.barkochba-story-summary').removeClass('active');
	$('a.barkochba-story-summary').filter(function (index) {
		return $(this).data("story-id") === storyId;
	}).addClass('active');

	// Show the details
	$('div.barkochba-story-detail').hide();
	$('div.barkochba-story-detail').filter(function (index) {
		return $(this).data("story-id") === storyId;
	}).show();
}

$(document).ready(function () {
	var personJsonData = {{ all_people_json|safe }};

    $("#names-input").select2({
    	placeholder: "Keress egy személy nevére",
    	allowClear: true,
    	minimumInputLength: 1,
    	multiple: true,
    	data:{ results: personJsonData }
	});

	$("#names-input").on("change", _namesChanged);
});
</script>

<body>

	<div class="container">
		<div>
			<div class="col-sm-12">
				<div class="names-input-container">
					<p>Keresd ki azon gyerekek neveit, akiknek mesélni szeretnél. Ezután a lista csak azokat a barkochbatörténeteket fogja mutatni, amiket még egyik gyerek sem hallott.</p>
					<p><input type='hidden' id="names-input" style="width: 100%;" /></p>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-sm-4">
				<div class="list-group">
					{% for story_map in stories %}
						<a href="#" class="list-group-item barkochba-story-summary" data-person-ids="{{ story_map.person_ids_json }}" data-story-id="{{ story_map.story.id }}" onclick="_storySelected({{ story_map.story.id }});">
							{{ story_map.story.order_number }} - {{ story_map.story.title }}
						</a>
					{% endfor %}
				</div>
			</div>

			<div class="col-sm-8">
				{% for story_map in stories %}
					<div class="panel panel-default barkochba-story-detail" data-story-id="{{ story_map.story.id }}">
						<div class="panel-heading">
							{{ story_map.story.order_number }} - {{ story_map.story.title }}
						</div>
						<div class="panel-body">
							<p>
								{{ story_map.story.story }}
							</p>

							<!--<button type="button" class="btn btn-default" data-toggle="collapse" data-target="#story-{{ story_map.story.id }}-solution">
								Megoldás
							</button>-->

							<div class="panel panel-default">
								<div class="panel-heading">
									<a href="#" data-toggle="collapse" data-target="#story-{{ story_map.story.id }}-solution">
										Megoldás
									</a>
								</div>
								<div class="collapse" id="story-{{ story_map.story.id }}-solution">
									<div class="panel-body">
										{{ story_map.story.solution }}
									</div>
								</div>
							</div>

							<p>
								Akik ismerik:<br />
								<div class="related-names-input-container">
									<input type='hidden' id="names-input-{{ story_map.story.id }}" style="width: 100%;" />
								</div>
								<button disabled type="button" id="related-people-save-button-{{ story_map.story.id }}" class="btn btn-sm btn-default">
									<span class="glyphicon glyphicon-pencil"></span> Mentés
								</button>
								<script type="text/javascript">
									var personJsonData = {{ all_people_json|safe }};
									var relatedPersonJsonData = {{ story_map.related_people_json|safe }};

								    $("#names-input-{{ story_map.story.id }}").select2({
								    	placeholder: "Keress egy személy nevére",
								    	allowClear: true,
								    	minimumInputLength: 1,
								    	multiple: true,
								    	data:{ results: personJsonData }
									});

								    // Prepopulating with the existing people
									$("#names-input-{{ story_map.story.id }}").select2(
										"data",
										relatedPersonJsonData
									);

									$("#names-input-{{ story_map.story.id }}").on("change", function() {
										$("#related-people-save-button-{{ story_map.story.id }}").prop("disabled", false);
									});

									$("#related-people-save-button-{{ story_map.story.id }}").on("click", function() {
										alert("{% url 'barkochba:update_people' %}");
										var peopleData = $("#names-input-{{ story_map.story.id }}").select2("data");
										var csrftoken = $.cookie('csrftoken');
										var jqxhr = $.ajax({
											url: "{% url 'barkochba:update_people' %}",
											type: "POST",
											data: peopleData,
											beforeSend: function(xhr, settings) {
												alert(csrftoken);
												xhr.setRequestHeader("X-CSRFToken", csrftoken);
											},
											success: function() {
												console.log('A mentés sikerült');
												$("#related-people-save-button-{{ story_map.story.id }}").prop("disabled", true);
											},
											error: function(data) {
												console.log('A mentés nem sikerült');
												alert('A mentés nem sikerült');
											}
										});
									});
								</script>
							</p>
						</div>
					</div>
				{% endfor %}
			</div>
		</div>

	</div>

</body>